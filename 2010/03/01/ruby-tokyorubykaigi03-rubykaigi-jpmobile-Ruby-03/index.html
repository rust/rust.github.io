<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.19-DEV" />

  <title>東京Ruby会議03 に行ってきた &middot; なんとなく日記</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://stnard.jp/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://stnard.jp/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://stnard.jp/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://stnard.jp/img/favicon.ico" type="image/x-icon" />

  
    <link rel="stylesheet" href="https://stnard.jp/css/custom.css">
  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://stnard.jp/">stnard.jp</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://stnard.jp/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://blog.stnard.jp"><i class='fa fa-list fa-fw'></i>Blog</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://stnard.jp/post/"><i class='fa fa-list fa-fw'></i>Old Posts</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/conceal_rs" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/rust.ogawa" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/rust" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/shin-ichiro-ogawa-2711891b" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/rust" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2016. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>東京Ruby会議03 に行ってきた</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2010/03/01</time>
  </div>

  

  

  

</div>


  

<ul>
<li>雨と東京マラソンとの戦い</li>
</ul>

<h2 id="メタプログラミング入門">メタプログラミング入門</h2>

<ul>
<li>Yugui さん

<ul>
<li>Ruby 1.9 Release Manager</li>
<li>Java の人</li>
<li>広告＆ニュース配信の仕事</li>
</ul></li>
</ul>

<h3 id="agenda">Agenda</h3>

<ul>
<li>メタプログラミングとは</li>
<li>Ruby における特性</li>
<li>道具立て

<ul>
<li>ニーズによっていろいろ変わるから，道具は紹介するのであとはみなさんで</li>
</ul></li>
<li>用例集</li>
</ul>

<h3 id="メタプログラミングとは">メタプログラミングとは</h3>

<ul>
<li>プログラムはプログラムすること</li>
<li>ループ

<ul>
<li>繰り返しに使う</li>
<li>コントロール配列を使う by VB界隈</li>
</ul></li>
<li>アクセサがあるクラス

<ul>
<li>getter / setter が沢山あるとメンテナンスするときに面倒になる</li>
<li>アクセサ名でループして attr_accessor とかする</li>
</ul></li>
</ul>

<h3 id="ruby-における特性">Ruby における特性</h3>

<ul>
<li>特性

<ul>
<li>非S式</li>
<li>First class object</li>
<li>コンパイルなし</li>
</ul></li>
<li>非S式

<ul>
<li>Lisp</li>
<li>S式</li>
<li>Ruby</li>
<li>ブロックがある

<ul>
<li>Proc</li>
<li>ループでメソッド定義とか</li>
</ul></li>
<li>文字列がある

<ul>
<li>文字列を eval してやる</li>
<li>ループでメソッド定義とか</li>
</ul></li>
</ul></li>
<li>コンパイルなし

<ul>
<li>コンパイルタイムなし</li>
<li>副作用がある</li>
<li>構文変更不可

<ul>
<li>マクロの否定</li>
</ul></li>
</ul></li>
</ul>

<pre><code class="language-ruby">class LogWritable
  %w[host time].each do |attr|
    attr_reader attr
  end
end
</code></pre>

<pre><code>    - 宣言ではなく普通に式であって，実行時に順次評価されるもの
      - コンパイル時にどうこうされるようなものではない
</code></pre>

<pre><code class="language-ruby">class Foo; end
class Bar; end
class Baz &lt; (rand &lt; 0.5 ? Foo : Bar)
  if gets == &quot;ok&quot;
    def foo; end
  end
end
</code></pre>

<pre><code>    - 実行時までどうなるかわからないので，Ruby を遅くしている要因の一つでもある
</code></pre>

<ul>
<li>メタプログラミングの例は C++

<ul>
<li>Ruby と同じことができるが，上記と同じような例ではコンパイル時に決定されてしまう</li>
<li>普通は Boost MPL を使うらしい</li>
</ul></li>
<li>副作用の存在がある

<ul>
<li>I/O に依存してプログラムの構造を変えるのは C++ では厳しい</li>
<li>リーダーマクロ by Lisp</li>
<li>Ruby にマクロが無いのは哲学</li>
</ul></li>
<li>DSL 不能

<ul>
<li>だが，それを可能にしているのがブロック</li>
<li>丁度いいバランス by matz</li>
<li>Rake / RSpec など

<ul>
<li>バランス</li>
<li>「Ruby であれば Ruby プログラマであれば誰でも読める」ことを残しつつ DSL やメタプログラムができるようになっている</li>
</ul></li>
</ul></li>
</ul>

<h3 id="道具立て">道具立て</h3>

<ul>
<li>Ruby に窮屈になれば

<ul>
<li>Java か Lisp に行くべきです</li>
</ul></li>
<li>クラス

<ul>
<li>Ruby は Class クラスのインスタンス</li>
</ul></li>
</ul>

<pre><code class="language-ruby">klass = Class.new do
          def foo; end
        end
</code></pre>

<ul>
<li>特異クラス

<ul>
<li>クラス階層

<ul>
<li>BasicObject &lt; Object &lt; Module &lt; Class</li>
</ul></li>
<li>特異メソッド</li>
</ul></li>
</ul>

<pre><code class="language-ruby">class Bar; end
bar1 = Bar.new
bar2 = Bar.new
def bar2.foo; end # =&gt; bar2 のみに定義される
</code></pre>

<pre><code>  - 特定のオブジェクトにだけメソッドを定義できる
- 特異クラス
  - bar2 に特異メソッドを作ったときには，内部的に新しいクラスを定義している
    - これを特異クラスと言う
      - Ruby からは見えないが，見る方法がある
</code></pre>

<pre><code class="language-ruby">eigenclass = (class &lt;&lt; obj; self end)
</code></pre>

<pre><code>- メタクラス
  - クラスのクラス
    - クラスのクラスは，特異クラス
</code></pre>

<pre><code class="language-ruby">class Foo
  def self.static; end # 特異メソッド定義
end
</code></pre>

<pre><code>    - Foo と言うクラスは Foo の特異クラスに属している
      - Foo を継承した Bar の特異クラスは，Foo の特異クラスを継承している
    - Class クラスにも特異クラスがある
</code></pre>

<ul>
<li>特異クラスは特殊なクラス

<ul>
<li>クラスなのでメタクラスを持っている</li>
<li>メタメタクラス？</li>
<li>Ruby のブート中は

<ul>
<li>全てのクラスは，クラスのメタクラスのインスタンスとなっている</li>
<li>全てのインスタンスは，特異クラスのインスタンス</li>
</ul></li>
<li>特異クラスのクラスメソッドを定義できるようにするために，さらに上位の構造があり，それが世界の果てまで続く

<ul>
<li>ブート中にこれをやるとメモリが無限に必要なので，縮退して最初の図になる</li>
</ul></li>
</ul></li>
<li>callable objects

<ul>
<li>Proc</li>
<li>ブロック</li>
<li>Proc.new / lambda / proc / &amp;blk

<ul>
<li>&amp;blk =&gt; 呼び出し時に指定されたブロックが Proc オブジェクトに変換されて渡されるもの</li>
</ul></li>
<li>Method</li>
<li>メソッド自身のオブジェクト</li>
<li>UnboundMethod</li>
<li>インスタンスが bind されていないメソッド</li>
<li>Method#bound &lt;-&gt; UnboundMethod#bind</li>
<li>Continuation</li>
<li>callcc</li>
<li>各種変換ができる</li>
</ul></li>
<li>eval 族

<ul>
<li>eval / instance_eval / class_eval</li>
<li>self</li>
<li>デフォルトのレシーバ</li>
<li>current class</li>
<li>メソッド定義時に指定されるクラス</li>
<li>TOPLEVEL</li>
<li>self -&gt; main</li>
<li>current class -&gt; Object</li>
<li>class 定義中</li>
<li>self -&gt; the class</li>
<li>current class -&gt; the class</li>
<li>def 式の中</li>
<li>self -&gt; 実行しているインスタンス自身</li>
<li>current class -&gt; NONE(無い)</li>
<li>instance_eval</li>
<li>self -&gt; インスタンス自身</li>
<li>current class -&gt; 特異クラス</li>
<li>class_eval</li>
<li>self -&gt; クラス自身</li>
<li>current class -&gt; クラス自身

<ul>
<li>特異メソッドが生成される</li>
</ul></li>
<li>eval</li>
<li>binding に依存する</li>
</ul></li>
<li>method_missing / send

<ul>
<li>&ldquo;いいですね&rdquo;</li>
</ul></li>
</ul>

<h3 id="用例集">用例集</h3>

<ul>
<li>メソッド定義

<ul>
<li>Rails で</li>
</ul></li>
</ul>

<pre><code class="language-ruby">class Foo &lt; ActiveRecord::Base
  [
    %w[bar bas],
    %w[hoge piyo]
  ].each do |through, to|
    has_one through
    has_one to, :through =&gt; through

    define_method(:&quot;#{to}=&quot;) do |val|
      self.send(:&quot;#{through}=&quot;, val.send(through))
    end
  end
end
</code></pre>

<pre><code>- eval の方が高速らしい
</code></pre>

<ul>
<li>メソッド定義

<ul>
<li>Forwardable を使ってアクセサを委譲する場合とか</li>
<li>メソッドとかクラスをまとめて定義するときとか</li>
</ul></li>
<li>DSL

<ul>
<li>RSpec とか

<ul>
<li>特定のブロック内でだけ be_true などを使えるような仕組みがある</li>
</ul></li>
</ul></li>
<li>Prime

<ul>
<li>クラス式が上から順に評価されるということの例</li>
</ul></li>
<li>モジュール定義

<ul>
<li>任意のブロックを受け取って，自分の環境下でだけ周りの副作用を与えずに評価したい場合に使う

<ul>
<li>プログラムの実行を隔離することで，環境の汚染を防ぐ</li>
</ul></li>
</ul></li>
</ul>

<pre><code class="language-ruby">def sandbox(&amp;block)
  Module.new(&amp;block)
end
</code></pre>

<ul>
<li>流し込み

<ul>
<li>起動に時間のかかる drb に irb を流しこんでリモートデバッグをしたいと思ったときに書いたコード

<ul>
<li>drb の環境下で実行結果の出力を，ローカルで生成したオブジェクトへの逆参照とすることで，リモートデバッグっぽくできる</li>
<li>不用意にポートを開けておくと危険！</li>
</ul></li>
</ul></li>
</ul>

<h2 id="ワークショップログ">ワークショップログ</h2>

<h3 id="東京-jpmobile-会議">東京 jpmobile 会議</h3>

<ul>
<li>どう Rack 化するか

<ul>
<li>Sinatra から使いたい</li>
</ul></li>
<li>Rails 2.3.x 用は

<ul>
<li>ブランチを分けて，タグを切ってリリースにあわせる</li>
<li>Rails 2.3.x 系はメンテナンスだけする</li>
</ul></li>
<li>Rack 化

<ul>
<li>Rack::Request</li>
<li>Jpmobile::Mobile のインスタンスにキャリアごとの機能を include するように作る方向

<ul>
<li>プラグインみたい拡張できるといいのではないか</li>
<li>Jpmobile.config.filter = true などで include する Module を指定できればいいかもしれず</li>
</ul></li>
</ul></li>
<li>テストはどうするか

<ul>
<li>Rack::Middleware としてテストする？</li>
</ul></li>
<li>絵文字は @mrkn さんの

<ul>
<li>デモを見せてもらいました！いい感じでできあがる予感！？</li>
</ul></li>
<li>Rails の文字エンコードの出入の部分

<ul>
<li>絵文字が変換されてしまわないかとかチェック</li>
<li>Content-type: を指定すればいい</li>
</ul></li>
<li>variants をどうするか

<ul>
<li>Proc を渡すとか</li>
<li>Proc で判定していく</li>
<li>動くものではなくて，仕様について相談してみるのがいいのではないか</li>
</ul></li>
<li>表 -&gt; リクエスト生成(jpmobile) -&gt; フィルター(jpmobile) -&gt; アプリケーション</li>
<li>絵文字変換のフォールバック

<ul>
<li>ハッシュテーブルとか文字を指定できれば</li>
</ul></li>
<li>変換テーブルとかIPアドレステーブルとかを外部に出すと本体のメンテナンスやパッケージ化とかで手を煩わせなくていいんじゃないか</li>
</ul>

<h3 id="まとめ">まとめ</h3>

<ul>
<li>とりあえず実装してみてはどうかと思ったので，Rack 化をやってみよう</li>
</ul>

<h2 id="a-reintroduction-to-ruby-m17n">A REINTRODUCTION TO RUBY M17N</h2>

<ul>
<li>成瀬さん</li>
<li>地球に生まれたことを後悔することになるらしい</li>
<li>文字コードとは

<ul>
<li>グリフやフォントよりちょっとした</li>
</ul></li>
<li>文字集合

<ul>
<li>違うことの決定</li>
</ul></li>
<li>何を扱うか

<ul>
<li>扱う文字を増やせば必要ビット数が増える</li>
</ul></li>
<li>文字の同定

<ul>
<li>何が一文字か</li>
</ul></li>
<li>字形の違い

<ul>
<li>g とか l とか</li>
<li>フォントや書体によって違う</li>
</ul></li>
<li>字体の違い

<ul>
<li>JISでは同じだが Unicode では別とか</li>
<li>JISでも Unicode でも同じコードポイントとか</li>
</ul></li>
<li>符号化文字集合

<ul>
<li>Coded Character Set</li>
<li>Unicode Scalar Value</li>
<li>ASCII / JIS X 0208 とか</li>
</ul></li>
<li>文字符号化方式

<ul>
<li>コードポイントを符号化する</li>
</ul></li>
<li>エンコーディング

<ul>
<li>あるバイトデータを解釈するには「文字符号化方式」と～を指定する必要がある</li>
</ul></li>
<li>IANA Charset

<ul>
<li>インターネット上に流すデータは登録されている必要がある</li>
</ul></li>
<li>charset -&gt; 文字集合</li>

<li><p>文字コード -&gt; 文字集合 or encoding</p></li>

<li><p>国際化の歴史</p>

<ul>
<li>I18N</li>
<li>L10N -&gt; Localization / M17N -&gt; Multilingualization</li>
</ul></li>

<li><p>もともと国際対応じゃない</p></li>

<li><p>最初は ASCII</p>

<ul>
<li>数字とアルファベットと記号の一部</li>
</ul></li>

<li><p>数が足りない</p>

<ul>
<li>拡張！</li>
<li>して 500 種類以上？！</li>
</ul></li>

<li><p>どうしてこうなった？</p>

<ul>
<li>製薬の中でベストを尽くそうとするため</li>
</ul></li>

<li><p>どうするか</p>

<ul>
<li>各個撃破</li>
<li>罠は「歴史的経緯」にあり！</li>
</ul></li>

<li><p>ISO 646 - 分裂の始まり</p></li>

<li><p>まだまだ足りないので</p></li>

<li><p>ISO/IEC 2022</p>

<ul>
<li>拡張方法を定めたもの</li>
</ul></li>

<li><p>ISO 2022 系</p>

<ul>
<li>詳しくは文字コード本を</li>
<li>状態を持つのでいろいろ大変</li>
</ul></li>

<li><p>そこで Unicode</p>

<ul>
<li>文字コードから地域・言語を分離</li>
<li>フラットな空間に全てを入れる</li>
</ul></li>

<li><p>Plain Text は存在しない</p></li>

<li><p>Legacy Encoding</p></li>

<li><p>CP932 を知ってますか？</p>

<ul>
<li>Windows 版 シフトJIS</li>
</ul></li>

<li><p>円記号問題「￥」</p>

<ul>
<li>ISO 646 の \ か￥かからはじまった</li>
<li>制御記号になったので</li>
</ul></li>

<li><p>シフトJISで問題が起こることも</p></li>

<li><p>波ダッシュ問題「～」</p>

<ul>
<li>JIS X 0208 と CP932 で違うコードに変換される</li>
</ul></li>

<li><p>機種依存文字</p></li>

<li><p>内部コードはどうするか</p>

<ul>
<li>UCS 正規化</li>
<li>入出力で変換する</li>
<li>CSI (Code Set Independent)</li>
</ul></li>

<li><p>Ruby 1.9</p>

<ul>
<li>String にエンコードがある</li>
<li>1.9 の String に必要なこと</li>
<li>encoding を適切に設定すること</li>
<li>encoding が誤ってるとき</li>
<li>IO と Encoding</li>
</ul></li>

<li><p>encoding とは</p>

<ul>
<li>String にとっての「型」</li>
</ul></li>

<li><p>Encoding</p>

<ul>
<li>エンコーディングを司るクラス</li>
</ul></li>

<li><p>nkf</p>

<ul>
<li>Network Kanji Filter</li>
</ul></li>

<li><p>kconv</p>

<ul>
<li>nkf のラッパー</li>
<li>勝手に MIME デコード</li>
<li>半角カナの全角変換</li>
</ul></li>

<li><p>iconv</p>

<ul>
<li>挙動が環境依存</li>
</ul></li>

<li><p>uconv</p>

<ul>
<li>Unicode 変換用拡張モジュール</li>
</ul></li>

<li><p>String#encode</p>

<ul>
<li>String#encode(to, from, opt)</li>
</ul></li>

<li><p>Encoding::Converter</p></li>

<li><p>不必要な変換は避ける</p></li>

<li><p>open() の引数に指定するなど</p></li>

<li><p>Ruby M17N の難しさ</p>

<ul>
<li>テストがしづらい</li>
</ul></li>

<li><p>SJIS と Windows-31J</p>

<ul>
<li>Windows 環境だと，入力は Windows-31J だから，Windows-31J が正しい</li>
</ul></li>

<li><p>ASCII非互換の正規表現</p>

<ul>
<li>リテラルで書けない</li>
<li>Regexp.new を使う</li>
</ul></li>

<li><p>ケータイ絵文字</p>

<ul>
<li>@mrkn さんたちが作業中</li>
<li>1.9.2 に入るかも</li>
</ul></li>

<li><p>Windows の Unicode パスについてはパッチ待ち？</p></li>

<li><p>結合文字</p>

<ul>
<li>「が」を「か」＋「゛」で表すとか</li>
<li>複数のコードポイントを1文字扱いにする必要がある</li>
</ul></li>

<li><p>異体字セレクタ/IVS</p></li>

<li><p>String と言語</p>

<ul>
<li>同時で扱えるかは文字コードによる</li>
<li>UTF-8 ではできない</li>
<li>Unicode は言語を別に与えないといけない</li>
<li>String に encoding と lang を持たせる必要がある</li>
<li>現在ユースケース不足</li>
<li>困難な壁に立ち向かった型がいれば ruby-list に</li>
</ul></li>

<li><p>Unicode ユーティリティ</p>

<ul>
<li>半角か全角かは文脈依存だったりする</li>
<li>Unicode 大文字小文字化</li>
</ul></li>

<li><p>String#sort</p>

<ul>
<li>デフォルトでは文字コード順</li>
<li>エンコーディングで並び順が変わってしまうことも</li>
</ul></li>

<li><p>Feedback を</p>

<ul>
<li>よい API を設計するために，ユースケースの feedback を</li>
</ul></li>
</ul>

<h3 id="質問">質問</h3>

<ul>
<li>コマンドラインからスクリプトのエンコーディングを指定する方法は？

<ul>
<li>マジックコメントを書け！</li>
</ul></li>
<li>昔 X って言うのがあって

<ul>
<li>バランスが大事ですね</li>
</ul></li>
<li>US-ASCII と ASCII-8BIT の文字列の足し算でエラーがでることがある

<ul>
<li>US-ASCII に 7bit 以外の文字が入っているんじゃないか？</li>
</ul></li>
<li>ZIP ファイルのエンコーディング問題

<ul>
<li>普通にもハマるところ</li>
</ul></li>
</ul>

<h2 id="open3-のはなし">open3 のはなし</h2>

<ul>
<li>田中哲さん</li>
<li>目的

<ul>
<li>プロセスを動かす方法を提供する</li>
<li>いい API を定義する</li>
</ul></li>
<li>Ruby のプロセス起動の問題

<ul>
<li>system or fork</li>
<li>system

<ul>
<li>環境依存だったりする</li>
</ul></li>
<li>fork

<ul>
<li>UNIX でしか動かない</li>
</ul></li>
</ul></li>
<li>解決

<ul>
<li>spawn メソッドの新設</li>
<li>open3 ライブラリの標準添付</li>
</ul></li>
<li>プロセス

<ul>
<li>ps コマンド出力の1行</li>
</ul></li>
<li>プロセス属性

<ul>
<li>カレントディレクトリ</li>
<li>相対パス解釈の起点</li>
<li>シェルによる指定

<ul>
<li>cd /usr とか</li>
</ul></li>
<li>リソースリミット</li>
<li>core ファイルのサイズ</li>
<li>CPU 時間</li>
<li>データサイズ</li>
<li>シェルにより指定

<ul>
<li>ulimit を使う</li>
</ul></li>
<li>ファイルディスクリプタ</li>
<li>ファイルアクセスのための番号</li>
</ul></li>
<li>標準入出力

<ul>
<li>fd の 0, 1, 2 は標準入力, 出力, エラー出力</li>
<li>0, 1, 2 は基本的に端末につながる</li>
</ul></li>
<li>リダイレクト

<ul>
<li>プロセスの標準入出力をファイルに繋ぎかえる</li>
</ul></li>
<li>パイプ

<ul>
<li>プロセスとプロセスをつなぐ</li>
</ul></li>
<li>Unix のプロセス起動

<ul>
<li>fork</li>
<li>fork を呼び出したプロセスの複製を作る</li>
<li>exec</li>
<li>exec を呼び出したプロセスを指定したコマンドで置き換える</li>
<li>fork と exec の組み合わせ</li>
</ul></li>
<li>非 UNIX では fork / exec は別れていない

<ul>
<li>プロセス属性を指定する引数が複雑になりがち</li>
</ul></li>
<li>Ruby で実現したいこと

<ul>
<li>OS が提供しているプロセス起動機能を使いたい</li>
<li>シェルでもできることをやりたい</li>
<li>Unix と 非 Unix で場合分けしたくない</li>
</ul></li>
<li>API 案

<ul>
<li>既存のメソッドを拡張する？ -&gt; 上手くいかない</li>
</ul></li>
<li>要求の衝突

<ul>
<li>いろいろあるので，ひとつのメソッドで全部出来そうにない</li>
</ul></li>
<li>高位・低位 API への分割

<ul>
<li>高位 API : よくやることを簡単に実現</li>
<li>open3</li>
<li>低位 API : なんでもできること</li>
<li>spawn</li>
</ul></li>
<li>高位API : open3

<ul>
<li>とりあえずパイプラインくらいまで提供</li>
<li>エスケープしたりとか，コマンドのステータスをみたいとか</li>
</ul></li>
<li>低位API : spawn

<ul>
<li>fork はポータブルじゃないとか</li>
</ul></li>
<li>ライブラリのレイヤ

<ul>
<li>高位になるほどライブラリの自由度が高く「賢い」</li>
<li>低位になるほど詳細な制御が可能になる</li>
</ul></li>
<li>open3 と spawn のレイヤ

<ul>
<li>open3</li>
<li>OS 間の共通機能にフォーカスした高位 API</li>
<li>spawn</li>
<li>OS 固有の機能も出来る限り指定できる程度に低位</li>
</ul></li>
</ul>

<h3 id="spawn-について">spawn について</h3>

<ul>
<li>プロセス起動手法には起源がある</li>
<li>いまの不満

<ul>
<li>いろいろ OS でできたことが Ruby 上からできない</li>
<li>プロセス起動の問題</li>
<li>ポータブルではない部分がある</li>
</ul></li>
<li>perl では？

<ul>
<li>Windows では fork エミュレーション</li>
<li>別スレッドで動く別インタプリタ</li>
</ul></li>
<li>ruby では？

<ul>
<li>spawn 関数の導入</li>
<li>fork + プロセス属性設定 + exec</li>
</ul></li>
<li>spawn の基本</li>
</ul>

<pre><code class="language-ruby">pid = spawn(&quot;make all&quot;)
Process.wait pid
</code></pre>

<ul>
<li>シェルを通さない方法も提供</li>
<li>リダイレクトもある</li>
</ul>

<pre><code class="language-ruby">spawn(&quot;make all&quot;, :out =&gt; &quot;make.log&quot;)
</code></pre>

<ul>
<li>標準エラー出力と標準出力のマージとか入れ替えとかも可能</li>
<li>パイプ処理</li>
<li>環境変数</li>
<li>spawn のオプション -&gt; マニュアルを</li>
<li>fork

<ul>
<li>プロセスが複製される</li>
<li>完全ではない</li>
</ul></li>
<li>exec

<ul>
<li>別のプロセスでコマンドを実行</li>
</ul></li>
<li>コマンド実行 = fork + exec</li>
<li>Ruby で fork を避ける理由

<ul>
<li>NetBSD 4 では fork した子プロセスではスレッドが動かないから</li>
</ul></li>
<li>spawn まとめ

<ul>
<li>Ruby 上で fork しなくてもいい</li>
</ul></li>
</ul>

<h3 id="open3-について">open3 について</h3>

<ul>
<li>標準添付ライブラリ

<ul>
<li>STDIN / STDOUT / STDERR とパイプを繋げて通信するライブラリ</li>
</ul></li>
<li>open3 の歴史は今日刻まれた</li>
<li>ゾンビプロセス

<ul>
<li>終了した後，親により wait されていないプロセス</li>
</ul></li>
<li>open3 で言われる問題

<ul>
<li>ゾンビ -&gt; double fork</li>
<li>Windows</li>
<li>終了ステータスが得られない -&gt; double fork だから</li>
<li>pid が得られない -&gt; シグナルを送るのが困難 -&gt; double fork だから</li>
</ul></li>
<li>亜種が発生</li>
<li>open3 による detach の効果

<ul>
<li>ゾンビが発生しない</li>
<li>double fork しないので pid が得られる</li>
<li>終了ステータスも得られる</li>
</ul></li>
<li>Open3.popen3 でいろいろ解決

<ul>
<li>でも足りないので高位 API が必要</li>
</ul></li>
<li>open3 と標準エラー出力

<ul>
<li>標準出力と別々のパイプにするには扱いが面倒</li>
<li>パイプにしないことがいいことも多い</li>
<li>ひとつのパイプにマージしていいケースもある</li>
</ul></li>
<li>高位 API のメソッド追加

<ul>
<li>出力を文字列で得る</li>
<li>os, es, st = Open3.capture3</li>
<li>標準出力と標準エラーを出力をマージする</li>
<li>Open3.popen2e</li>
<li>パイプライン</li>
<li>Open3.pipeline</li>
</ul></li>
<li>複数パイプラインは必要か？

<ul>
<li>spawn によるパイプラインは厄介</li>
<li>パイプを作って閉じて～を繰り返す必要がある</li>
</ul></li>
<li>shell ライブラリ というのもある</li>
</ul>

<h3 id="まとめ-1">まとめ</h3>

<ul>
<li>spawn / open3 の紹介</li>
<li>高位と低位に分けたデザイン</li>
<li>パイプの用法の考察</li>
</ul>

<h2 id="懇親会">懇親会</h2>

<ul>
<li>エアとしていろいろ．そろそろかとかいろいろ．</li>
</ul>

<h2 id="全体のまとめ">全体のまとめ</h2>

<ul>
<li>クラス/メソッド定義中のスコープについて考えると，特異メソッドやクラスメソッドのことがよくわかる</li>
<li>評価順は上からであって，クラス式は宣言式ではないので，C のように考えてはいけない</li>
<li>実際会議っぽくなりました</li>
<li>文字周りはいろいろカオスですね</li>
<li>プロセス周りはちゃんと勉強したいです</li>
</ul>


  <div class="share-buttons">
    <div class="fb-like" data-href="https://stnard.jp/2010/03/01/ruby-tokyorubykaigi03-rubykaigi-jpmobile-Ruby-03/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="true"></div>
    <div class="hatena-share-button"><a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script></div>
    <div class="twitter-share-button"><a href="https://twitter.com/share" class="twitter-share-button" data-via="conceal_rs">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div>
</div>
<div id="fb-root"></div>
<script>(function(d, s, id) {
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) return;
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/ja_KS/sdk.js#xfbml=1&version=v2.8";
     fjs.parentNode.insertBefore(js, fjs);
 }(document, 'script', 'facebook-jssdk'));</script>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://stnard.jp/2010/01/27/ruby-rails-git-git/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://stnard.jp/2010/01/27/ruby-rails-git-git/">git で空ディレクトリを追加するには</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://stnard.jp/2010/03/09/git-Git-2/">実用Git - 2冊目に読む本</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://stnard.jp/2010/03/09/git-Git-2/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'stnardsdiary';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

</div>
</div>
<script src="https://stnard.jp/js/ui.js"></script>


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-33462373-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-33462373-1');
</script>



</body>
</html>

